stages:
  - test-build
  - test
  - deploy-build
  - deploy-green
  - test-green
  - deploy-blue
  - rollback

default:
  image: docker:latest
  services:
    - docker:dind

before_script:
  - mkdir -p ~/.ssh
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - ssh-keyscan -H $BLUE_SERVER_IP $GREEN_SERVER_IP $LOAD_BALANCER_IP >> ~/.ssh/known_hosts

# Stage 1: Build the dev environment for testing
test-build:
  stage: test-build
  script:
    - echo "Building test environment..."
    - docker build -t my-app-backend-dev -f ./backend/Dockerfile.dev ./backend
    - docker build -t my-app-frontend-dev -f ./frontend/Dockerfile.dev ./frontend

# Stage 2: Run tests
test:
  stage: test
  script:
    - echo "Running backend tests..."
    - docker run --rm my-app-backend-dev deno test
    - echo "Running frontend tests..."
    - docker run --rm my-app-frontend-dev npm run test

# Stage 3: Build the prod environment for deployment
deploy-build:
  stage: deploy-build
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building production Docker images..."
    - docker build -t "$DOCKER_NAMESPACE/$DOCKER_REPOSITORY-backend:latest" -f ./backend/Dockerfile.prod ./backend
    - docker build -t "$DOCKER_NAMESPACE/$DOCKER_REPOSITORY-frontend:latest" -f ./frontend/Dockerfile.prod ./frontend
    - echo "Pushing Docker images to Docker Hub..."
    - docker push "$DOCKER_NAMESPACE/$DOCKER_REPOSITORY-backend:latest"
    - docker push "$DOCKER_NAMESPACE/$DOCKER_REPOSITORY-frontend:latest"
  after_script:
    - docker images

# Stage 4: Deploy to Green environment
deploy-green:
  stage: deploy-green
  script:
    - echo "Deploying to Green environment..."
    - ssh $DEPLOY_USER_GREEN@$GREEN_SERVER_IP "docker pull $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-backend:latest && docker pull $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-frontend:latest"
    - ssh $DEPLOY_USER_GREEN@$GREEN_SERVER_IP "docker stop backend || true && docker stop frontend || true"
    - ssh $DEPLOY_USER_GREEN@$GREEN_SERVER_IP "docker rm backend || true && docker rm frontend || true"
    - ssh $DEPLOY_USER_GREEN@$GREEN_SERVER_IP "docker run -d --name backend -p 4000:4000 $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-backend:latest"
    - ssh $DEPLOY_USER_GREEN@$GREEN_SERVER_IP "docker run -d --name frontend -p 80:3000 $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-frontend:latest"

# Stage 5: Test Green environment
test-green:
  stage: test-green
  script:
    - echo "Performing health checks on Green environment..."
    - curl -f http://$GREEN_SERVER_IP:4000/health || (echo 'Green environment health check failed!' && exit 1)
    - echo "Green environment is healthy."

# Stage 6: Deploy to Blue environment
deploy-blue:
  stage: deploy-blue
  script:
    - echo "Deploying to Blue environment..."
    - ssh $DEPLOY_USER_BLUE@$BLUE_SERVER_IP "docker pull $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-backend:latest && docker pull $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-frontend:latest"
    - ssh $DEPLOY_USER_BLUE@$BLUE_SERVER_IP "docker stop backend || true && docker stop frontend || true"
    - ssh $DEPLOY_USER_BLUE@$BLUE_SERVER_IP "docker rm backend || true && docker rm frontend || true"
    - ssh $DEPLOY_USER_BLUE@$BLUE_SERVER_IP "docker run -d --name backend -p 4000:4000 $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-backend:latest"
    - ssh $DEPLOY_USER_BLUE@$BLUE_SERVER_IP "docker run -d --name frontend -p 80:3000 $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-frontend:latest"
    - echo "Switching load balancer to Blue environment..."
    - ssh $DEPLOY_USER_LOADB@$LOAD_BALANCER_IP "/usr/local/bin/switch_env.sh blue"

# Stage 7: Rollback in case of failure
rollback:
  stage: rollback
  script:
    - echo "Rolling back Green environment due to failure..."
    - ssh $DEPLOY_USER_GREEN@$GREEN_SERVER_IP "docker stop backend || true && docker stop frontend || true"
    - ssh $DEPLOY_USER_GREEN@$GREEN_SERVER_IP "docker rm backend || true && docker rm frontend || true"
    - echo "Reverting load balancer to Blue environment..."
    - ssh $DEPLOY_USER_LOADB@$LOAD_BALANCER_IP "/usr/local/bin/switch_env.sh blue"
  when: on_failure
