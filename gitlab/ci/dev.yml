build-dev-backend:
  stage: build-dev-backend
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building backend Docker image for Dev environment..."
    - docker build -t "$DOCKER_NAMESPACE/$DOCKER_REPOSITORY-backend-dev:latest" -f ./backend/Dockerfile.dev ./backend
    - docker push "$DOCKER_NAMESPACE/$DOCKER_REPOSITORY-backend-dev:latest"

build-dev-frontend:
  stage: build-dev-frontend
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building frontend Docker image for Dev environment..."
    - docker build -t "$DOCKER_NAMESPACE/$DOCKER_REPOSITORY-frontend-dev:latest" -f ./frontend/Dockerfile.dev ./frontend
    - docker push "$DOCKER_NAMESPACE/$DOCKER_REPOSITORY-frontend-dev:latest"

deploy-dev-backend:
  stage: deploy-dev-backend
  dependencies:
    - build-dev-backend
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $LOAD_BALANCER_IP >> ~/.ssh/known_hosts
  script:
    - echo "Deploying backend Dev environment on Load Balancer..."
    - ssh $DEPLOY_USER_LOADB@$LOAD_BALANCER_IP "
      docker pull $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-backend-dev:latest &&
      docker stop dev-backend || true &&
      docker rm dev-backend || true &&
      docker run -d --name dev-backend -p 4000:4000 $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-backend-dev:latest
      "

deploy-dev-frontend:
  stage: deploy-dev-frontend
  dependencies:
    - build-dev-frontend
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $LOAD_BALANCER_IP >> ~/.ssh/known_hosts
  script:
    - echo "Deploying frontend Dev environment on Load Balancer..."
    - ssh $DEPLOY_USER_LOADB@$LOAD_BALANCER_IP "
      docker pull $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-frontend-dev:latest &&
      docker stop dev-frontend || true &&
      docker rm dev-frontend || true &&
      docker run -d --name dev-frontend -p 80:3000 $DOCKER_NAMESPACE/$DOCKER_REPOSITORY-frontend-dev:latest
      "

test-dev-backend:
  stage: test-dev-backend
  dependencies:
    - deploy-dev-backend
  script:
    - echo "Testing backend Dev environment on Load Balancer..."
    - curl -f http://$LOAD_BALANCER_IP:4000/health || (echo 'Backend health check failed!' && exit 1)

test-dev-frontend:
  stage: test-dev-frontend
  dependencies:
    - deploy-dev-frontend
  script:
    - echo "Testing frontend Dev environment on Load Balancer..."
    - curl -f http://$LOAD_BALANCER_IP || (echo 'Frontend health check failed!' && exit 1)
