# release.yml

release:
  stage: release
  dependencies:
    - test-request-prod-backend-blue
    - test-request-prod-frontend-blue
  script:
    - echo "Creating GitLab release..."
    - export RELEASE_TAG=$(date +%Y.%m.%d.%H%M%S)
    - git tag "$RELEASE_TAG"
    - git push origin "$RELEASE_TAG"
    - |
      curl --request POST \
           --header "PRIVATE-TOKEN: $GITLAB_PRIVATE_TOKEN" \
           --data "name=Release $RELEASE_TAG&tag_name=$RELEASE_TAG&description=Automated release $RELEASE_TAG" \
           "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"

release-mobile:
  stage: release-mobile
  dependencies:
    - test-auto-mobile
  before_script:
    - apt-get update && apt-get install -y jq
  script: |
    echo "Packaging and pushing APK to GitLab..."
    cd mobile/android/app/build/outputs/apk/release/
    cp app-release.apk "$CI_PROJECT_DIR"
    cd "$CI_PROJECT_DIR"
    curl --request POST \
         --header "PRIVATE-TOKEN: $GITLAB_PRIVATE_TOKEN" \
         --form "file=@app-release.apk" \
         "$CI_API_V4_URL/projects/$CI_PROJECT_ID/uploads" > upload_response.json
    FILE_URL=$(jq -r '.url' upload_response.json)
    echo "APK uploaded to GitLab: $FILE_URL"
